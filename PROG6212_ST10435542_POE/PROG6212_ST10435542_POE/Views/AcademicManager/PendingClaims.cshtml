@using PROG6212_ST10435542_POE.Models.ViewModels.Approval

@model List<PendingClaimViewModel>
@{
    ViewData["Title"] = "Pending Claims for Review (Academic Manager)";
}

@* I made use of Empty Razor View and incorporated code from previous MVC projects and made minor tweaks to my liking *@
@* These views mainly made use of the ViewModels ive created in order to manipulate which data i wanted in specific views, instead of the mai models according to the database schema *@

<h1>Academic Manager</h1>
<p></p>
<h4>Pending Claims for Review</h4>
<p>Here is a list of all claims awaiting your verification and approval.</p>

<table class="table table-striped table-hover">
    <thead>
        <tr>
            <th>Claim ID</th>
            <th>Lecturer</th>
            <th>Submission Date</th>
            <th>Claim Period</th>
            <th>Total Amount</th>
            <th>Status</th>
            <th>Supporting Document</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody>
        @if (Model != null && Model.Any()) // checks if there are pending claims to display
        {
            foreach (var claim in Model) // iterates over each claim in the model
            {
                <tr>
                    <td>@claim.ClaimID</td>
                    <td>@claim.LecturerName</td>
                    <td>@claim.SubmissionDate.ToString("dd/MM/yyyy")</td>
                    <td>@claim.ClaimPeriod.ToString("MMMM yyyy")</td>
                    <td>R @claim.TotalAmount.ToString("N2")</td> @* formats amount with currency symbol and two decimals *@
                    <td>@claim.Status</td>
                    <td>
                        @if (!string.IsNullOrEmpty(claim.FilePath)) @* checks if supporting document exists *@
                        {
                            <a href="@Url.Action("Download", "File", new { id = claim.ClaimID })" class="btn btn-outline-primary">View Document</a> @* link to download/view document *@
                        }
                        else
                        {
                            <span class="text-muted">No document</span>
                        }
                    </td>
                    <td>
                        <a asp-controller="AcademicManager" asp-action="ReviewClaim" asp-route-id="@claim.ClaimID" class="btn btn-info">Review</a> @* link to detailed review page *@
                        <button type="button" class="btn btn-success" onclick="approveClaim(@claim.ClaimID)">Approve</button> @* button to approve claim with JS function *@
                        <button type="button" class="btn btn-danger" onclick="rejectClaim(@claim.ClaimID)">Reject</button> @* button to reject claim with JS function *@
                    </td>
                </tr>
            }
        }
        else
        {
            <tr><td colspan="8" class="text-center text-muted">No pending claims found.</td></tr>
        }
    </tbody>
</table>

<script>
    function approveClaim(claimId) { @* js function to handle claim approval *@
        if (confirm('Are you sure you want to approve this claim?')) { @* confirmation prompt *@
            $.ajax({ @* send asynchronously post request to approve the claim *@
                url: '@Url.Action("Approve", "AcademicManager")',
                type: 'POST',
                data: { id: claimId }, @* sends the claim id *@
                success: function(response) {
                    if (response.success) {
                        alert(response.message);
                        location.reload();
                    } else {
                        alert('Error: ' + response.message);
                    }
                },
                error: function() {
                    alert('An error occurred while processing the request.');
                }
            });
        }
    }

    function rejectClaim(claimId) {
        if (confirm('Are you sure you want to reject this claim?')) { @* confirmation prompt *@
            $.ajax({ @* send asynchronously post request to approve the claim *@
                url: '@Url.Action("Reject", "AcademicManager")',
                type: 'POST',
                data: { id: claimId },
                success: function(response) {
                    if (response.success) {
                        alert(response.message);
                        location.reload();
                    } else {
                        alert('Error: ' + response.message);
                    }
                },
                error: function() {
                    alert('An error occurred while processing the request.');
                }
            });
        }
    }
</script>